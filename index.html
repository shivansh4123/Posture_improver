<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Posture Detection Tool</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/pose@0.8/dist/teachablemachine-pose.min.js"></script>
  <style>
    .camera-frame {
      position: relative;
      width: 100%;
      max-width: 640px;
      height: 480px;
      background-color: #111;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
    }
    .posture-indicator {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background-color: #ef4444;
      box-shadow: 0 0 10px rgba(239, 68, 68, 0.7);
      transition: all 0.3s ease;
    }
    .posture-indicator.good {
      background-color: #10b981;
      box-shadow: 0 0 10px rgba(16, 185, 129, 0.7);
    }
    .skeleton-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,0.1) 50%, rgba(255,255,255,0) 100%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
    }
    @keyframes shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center justify-center p-4">
  <div class="w-full max-w-4xl bg-white rounded-2xl shadow-xl overflow-hidden">
    <div class="bg-indigo-600 text-white p-6">
      <h1 class="text-3xl font-bold text-center">Posture Detection</h1>
      <p class="text-center text-indigo-100 mt-2">Keep your back straight and shoulders relaxed</p>
    </div>

    <div class="p-6 md:p-8 flex flex-col md:flex-row gap-8">
      <div class="flex-1">
        <div class="camera-frame mx-auto" id="cameraFrame">
          <div class="skeleton-overlay" id="skeletonOverlay"></div>
          <div class="posture-indicator" id="postureIndicator"></div>
          <video id="video" autoplay playsinline class="w-full h-full object-cover" style="display: none;"></video>
          <canvas id="canvas" class="w-full h-full object-cover"></canvas>
        </div>
      </div>

      <div class="flex-1 flex flex-col">
        <div class="bg-gray-50 p-6 rounded-lg mb-6">
          <h2 class="text-xl font-semibold text-gray-800 mb-4">Posture Analysis</h2>
          <div id="label-container" class="space-y-2 text-sm text-gray-700"></div>

          <label for="modelSelect" class="block text-black-600 text-bm mb-1">Select Model:</label>
<select id="modelSelect" class="w-full px-3 py-2 border rounded-lg text-gray-700 mb-4">
  <option value="laptop">PC Webcam</option>
  <option value="webcam">laptop cam</option>
</select>


          <label for="alertType" class="block text-black-600 text-bm mb-1 mt-4">Alert Type:</label>
          <select id="alertType" class="w-full px-3 py-2 border rounded-lg text-gray-700">
            <option value="voice">Voice Alarm</option>
            <option value="notification">Notification</option>
          </select>

          <div id="voiceSelectorWrapper" class="mt-3">
            <label for="soundSelect" class="block text-black-600 text-bm mb-1">Select Alarm Voice:</label>
            <select id="soundSelect" class="w-full px-3 py-2 border rounded-lg text-gray-700">
              <option value="1.mp3">Jessica</option>
              <option value="3.mp3">Uncle Roger</option>
              <option value="2.mp3">Sergeant</option>
            </select>
          </div>
        </div>

        <div class="mt-auto">
          <button id="startButton" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 px-6 rounded-lg text-lg transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
            Start Posture Detection
          </button>
          <div class="mt-4 text-center text-gray-500 text-sm">
            <p>Make sure your upper body is visible in the frame</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <audio id="wakeUpAudio">
    <source src="1.mp3" type="audio/mpeg">
    Your browser does not support the audio element.
  </audio>

  <script>
  let MODEL_URLS = {
    laptop: "https://teachablemachine.withgoogle.com/models/48gDy9yDy/",
    webcam: "https://teachablemachine.withgoogle.com/models/8tMxygQ9W/"
  };

  let model, webcam, ctx, labelContainer, maxPredictions;
  let aud = document.getElementById("wakeUpAudio");
  let detecting = false;
  let lastNotificationTime = 0;

  const alertType = document.getElementById("alertType");
  const voiceSelectorWrapper = document.getElementById("voiceSelectorWrapper");

  if (Notification.permission !== "granted") {
    Notification.requestPermission().then(res => console.log("Notification permission:", res));
  }

  alertType.addEventListener("change", () => {
    voiceSelectorWrapper.style.display = alertType.value === "voice" ? "block" : "none";
  });

  document.getElementById("soundSelect").addEventListener("change", function () {
    const selected = this.value;
    aud.pause();
    aud.src = selected;
    aud.load();
  });

  function playAud() {
    const mode = document.getElementById("alertType").value;
    const now = Date.now();

    if (mode === "voice") {
      if (aud.paused) aud.play();
    } else if (mode === "notification") {
      if (Notification.permission === "granted" && (now - lastNotificationTime) > 5000) {
        new Notification("⚠️ Bad posture detected!");
        lastNotificationTime = now;
      }
    }
  }

  function pauseAud() {
    if (!aud.paused) aud.pause();
  }

  async function init() {
    const selectedModelKey = document.getElementById("modelSelect").value;
    const URL = MODEL_URLS[selectedModelKey];
    const modelURL = URL + "model.json";
    const metadataURL = URL + "metadata.json";

    model = await tmPose.load(modelURL, metadataURL);
    maxPredictions = model.getTotalClasses();

    const size = 400;
    const flip = true;
    webcam = new tmPose.Webcam(size, size, flip);
    await webcam.setup();
    await webcam.play();

    const canvas = document.getElementById("canvas");
    canvas.width = size;
    canvas.height = size;
    ctx = canvas.getContext("2d");

    labelContainer = document.getElementById("label-container");
    labelContainer.innerHTML = "";
    for (let i = 0; i < maxPredictions; i++) {
      labelContainer.appendChild(document.createElement("div"));
    }

    document.getElementById("video").style.display = "none";
    document.getElementById("canvas").style.display = "block";
    document.getElementById("skeletonOverlay").style.display = "none";

    detecting = true;
    detectLoop();
  }

  async function detectLoop() {
    while (detecting) {
      webcam.update();
      await predict();
      await new Promise(resolve => setTimeout(resolve, 50));
    }
  }

  async function predict() {
    const { pose, posenetOutput } = await model.estimatePose(webcam.canvas);
    const prediction = await model.predict(posenetOutput);

    for (let i = 0; i < maxPredictions; i++) {
      const classPrediction = prediction[i].className + ": " + prediction[i].probability.toFixed(2);
      labelContainer.childNodes[i].innerHTML = classPrediction;

      if (prediction[1].probability.toFixed(2) >= 0.75)
        playAud();
      else
        pauseAud();
    }

    drawPose(pose);
  }

  function drawPose(pose) {
    if (webcam.canvas) {
      ctx.drawImage(webcam.canvas, 0, 0);
      if (pose) {
        const minPartConfidence = 0.5;
        tmPose.drawKeypoints(pose.keypoints, minPartConfidence, ctx);
        tmPose.drawSkeleton(pose.keypoints, minPartConfidence, ctx);
      }
    }
  }

  document.getElementById("startButton").addEventListener("click", function () {
    if (!model) {
      this.textContent = "Detecting Posture...";
      init();
      this.textContent = "Stop Detection";
      this.classList.replace("bg-indigo-600", "bg-red-600");
      this.classList.replace("hover:bg-indigo-700", "hover:bg-red-700");
    } else {
      detecting = false;
      webcam.stop();
      model = null;
      document.getElementById("canvas").style.display = "none";
      document.getElementById("skeletonOverlay").style.display = "block";
      this.textContent = "Start Posture Detection";
      this.classList.replace("bg-red-600", "bg-indigo-600");
      this.classList.replace("hover:bg-red-700", "hover:bg-indigo-700");
      pauseAud();
    }
  });
</script>

</body>
</html>
